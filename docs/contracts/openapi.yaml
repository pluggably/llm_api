openapi: 3.1.0
info:
  title: Pluggably LLM API Gateway
  version: 0.1.0
  description: |
    Standard API for text, image, and 3D generation via commercial, public, or local OSS models.

servers:
  - url: http://localhost:8000
    description: Local development

paths:
  /v1/generate:
    post:
      summary: Generate text, image, or 3D output
      operationId: generate
      tags: [Generation]
      security:
        - apiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
      responses:
        '200':
          description: Successful generation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          $ref: '#/components/responses/BackendUnavailable'

  /v1/models:
    get:
      summary: List available models and capabilities
      operationId: listModels
      tags: [Models]
      security:
        - apiKey: []
      parameters:
        - name: modality
          in: query
          schema:
            type: string
            enum: [text, image, 3d]
      responses:
        '200':
          description: Model catalog
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelCatalog'

  /v1/models/{modelId}:
    get:
      summary: Get detailed model information
      operationId: getModelInfo
      tags: [Models]
      security:
        - apiKey: []
      parameters:
        - name: modelId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Model details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModelInfo'
        '404':
          description: Model not found

  /v1/schema:
    get:
      summary: Get API schema and parameter documentation
      operationId: getSchema
      tags: [Operations]
      security:
        - apiKey: []
      responses:
        '200':
          description: API schema and parameter documentation
          content:
            application/json:
              schema:
                type: object

  /v1/sessions:
    post:
      summary: Create a new session
      operationId: createSession
      tags: [Sessions]
      security:
        - apiKey: []
      responses:
        '201':
          description: Session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
    get:
      summary: List sessions
      operationId: listSessions
      tags: [Sessions]
      security:
        - apiKey: []
      responses:
        '200':
          description: Sessions list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionList'

  /v1/sessions/{sessionId}:
    get:
      summary: Get session details
      operationId: getSession
      tags: [Sessions]
      security:
        - apiKey: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '404':
          description: Session not found
    delete:
      summary: Close a session
      operationId: closeSession
      tags: [Sessions]
      security:
        - apiKey: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session closed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'

  /v1/sessions/{sessionId}/reset:
    post:
      summary: Reset session context
      operationId: resetSession
      tags: [Sessions]
      security:
        - apiKey: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session reset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'

  /v1/sessions/{sessionId}/generate:
    post:
      summary: Generate with session context
      operationId: generateWithSession
      tags: [Sessions]
      security:
        - apiKey: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateRequest'
      responses:
        '200':
          description: Successful generation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenerateResponse'

  /v1/providers:
    get:
      summary: List supported providers and configuration status
      operationId: listProviders
      tags: [Providers]
      security:
        - apiKey: []
      responses:
        '200':
          description: Provider status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProvidersResponse'

  /v1/models/download:
    post:
      summary: Download and register a new model
      operationId: downloadModel
      tags: [Models]
      security:
        - apiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModelDownloadRequest'
      responses:
        '202':
          description: Download job accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DownloadJobStatus'

  /v1/jobs/{jobId}:
    get:
      summary: Get download job status
      operationId: getJobStatus
      tags: [Jobs]
      security:
        - apiKey: []
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DownloadJobStatus'
    delete:
      summary: Cancel download job
      operationId: cancelJob
      tags: [Jobs]
      security:
        - apiKey: []
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DownloadJobStatus'

  /v1/artifacts/{artifactId}:
    get:
      summary: Get artifact content
      operationId: getArtifact
      tags: [Artifacts]
      parameters:
        - name: artifactId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Artifact content
          content:
            application/json:
              schema:
                type: object
                properties:
                  artifact_id:
                    type: string
                  content_base64:
                    type: string

  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags: [Operations]
      responses:
        '200':
          description: Healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /ready:
    get:
      summary: Readiness check
      operationId: readinessCheck
      tags: [Operations]
      responses:
        '200':
          description: Ready
        '503':
          description: Not ready

components:
  securitySchemes:
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    GenerateRequest:
      type: object
      required: [modality, input]
      properties:
        model:
          type: string
          description: Model ID (optional; uses default if omitted)
        session_id:
          type: string
          description: Optional session ID to reuse context
        state_tokens:
          type: object
          additionalProperties: true
          description: Optional provider/model-specific state passthrough
        modality:
          type: string
          enum: [text, image, 3d]
        input:
          type: object
          properties:
            prompt:
              type: string
            images:
              type: array
              items:
                type: string
                format: byte
            mesh:
              type: string
        parameters:
          type: object
          properties:
            temperature:
              type: number
            max_tokens:
              type: integer
            format:
              type: string
        stream:
          type: boolean
          default: false

    GenerateResponse:
      type: object
      properties:
        request_id:
          type: string
        model:
          type: string
        modality:
          type: string
        session_id:
          type: string
        state_tokens:
          type: object
          additionalProperties: true
        output:
          type: object
          properties:
            text:
              type: string
            images:
              type: array
              items:
                type: string
                format: byte
            mesh:
              type: string
            artifacts:
              type: array
              items:
                $ref: '#/components/schemas/Artifact'
        usage:
          type: object
          properties:
            prompt_tokens:
              type: integer
            completion_tokens:
              type: integer
            total_tokens:
              type: integer

    Artifact:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum: [image, mesh]
        url:
          type: string
          format: uri
        expires_at:
          type: string
          format: date-time

    ModelCatalog:
      type: object
      properties:
        models:
          type: array
          items:
            $ref: '#/components/schemas/ModelInfo'
        next_cursor:
          type: string
          nullable: true

    ProvidersResponse:
      type: object
      properties:
        providers:
          type: array
          items:
            $ref: '#/components/schemas/ProviderStatus'

    ProviderStatus:
      type: object
      properties:
        name:
          type: string
        configured:
          type: boolean
        supported_modalities:
          type: array
          items:
            type: string
            enum: [text, image, 3d]

    ModelInfo:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        version:
          type: string
        modality:
          type: string
          enum: [text, image, 3d]
        provider:
          type: string
        capabilities:
          type: object
          properties:
            max_context_tokens:
              type: integer
            output_formats:
              type: array
              items:
                type: string
            hardware_requirements:
              type: array
              items:
                type: string
        source:
          type: object
          properties:
            type:
              type: string
              enum: [huggingface, url, local]
            uri:
              type: string
        size_bytes:
          type: integer
        local_path:
          type: string
        last_used_at:
          type: string
          format: date-time
        is_default:
          type: boolean
        status:
          type: string
          enum: [available, downloading, failed, disabled, evicted]

    ModelDownloadRequest:
      type: object
      required: [model, source]
      properties:
        model:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
            version:
              type: string
            modality:
              type: string
              enum: [text, image, 3d]
        source:
          type: object
          properties:
            type:
              type: string
              enum: [huggingface, url, local]
            id:
              type: string
            uri:
              type: string
        options:
          type: object
          properties:
            revision:
              type: string
            sha256:
              type: string
            allow_large:
              type: boolean

    DownloadJobStatus:
      type: object
      properties:
        job_id:
          type: string
        model_id:
          type: string
        status:
          type: string
          enum: [queued, running, completed, failed, cancelled]
        progress_pct:
          type: number
        error:
          type: string

    Session:
      type: object
      properties:
        id:
          type: string
        status:
          type: string
          enum: [active, closed]
        created_at:
          type: string
          format: date-time
        last_used_at:
          type: string
          format: date-time

    SessionList:
      type: object
      properties:
        sessions:
          type: array
          items:
            $ref: '#/components/schemas/Session'

  responses:
    ValidationError:
      description: Invalid request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              code:
                type: string
              details:
                type: array
                items:
                  type: object

    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              code:
                type: string

    BackendUnavailable:
      description: Backend provider unavailable
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              code:
                type: string
              retry_after:
                type: integer
