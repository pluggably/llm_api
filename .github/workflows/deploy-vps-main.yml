name: Deploy VPS on main

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: deploy-vps-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Redeploy on VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -euo pipefail

            APPS_ROOT="/srv/apps"
            if [ ! -w "$APPS_ROOT" ]; then
              APPS_ROOT="$HOME/apps"
            fi
            APP_ROOT="$APPS_ROOT/llm_api"
            VPS_CONFIG_ROOT="$APPS_ROOT/vps-config"
            DEPLOY_BRANCH="${{ github.ref_name }}"

            resolve_branch() {
              local repo="$1"
              local requested="$2"

              if git -C "$repo" show-ref --verify --quiet "refs/remotes/origin/$requested"; then
                echo "$requested"
              elif git -C "$repo" show-ref --verify --quiet "refs/remotes/origin/main"; then
                echo "main"
              else
                echo "master"
              fi
            }

            mkdir -p "$APPS_ROOT"

            mkdir -p "$HOME/.ssh"
            touch "$HOME/.ssh/known_hosts"
            chmod 700 "$HOME/.ssh"
            chmod 600 "$HOME/.ssh/known_hosts"
            if ! ssh-keygen -F github.com >/dev/null; then
              ssh-keyscan -H github.com >> "$HOME/.ssh/known_hosts"
            fi

            if [ ! -d "$APP_ROOT/.git" ]; then
              git clone git@github.com:pluggably/llm_api.git "$APP_ROOT"
            fi

            if [ ! -d "$VPS_CONFIG_ROOT/.git" ]; then
              git clone git@github.com:pluggably/vps-config.git "$VPS_CONFIG_ROOT"
            fi

            git -C "$APP_ROOT" remote set-url origin git@github.com:pluggably/llm_api.git
            git -C "$VPS_CONFIG_ROOT" remote set-url origin git@github.com:pluggably/vps-config.git

            git -C "$APP_ROOT" fetch --prune origin
            APP_BRANCH="$(resolve_branch "$APP_ROOT" "$DEPLOY_BRANCH")"
            git -C "$APP_ROOT" reset --hard "origin/$APP_BRANCH"

            git -C "$VPS_CONFIG_ROOT" fetch --prune origin
            VPS_BRANCH="$(resolve_branch "$VPS_CONFIG_ROOT" "$DEPLOY_BRANCH")"
            git -C "$VPS_CONFIG_ROOT" reset --hard "origin/$VPS_BRANCH"

            TRAEFIK_SRC_DYNAMIC="$VPS_CONFIG_ROOT/traefik/dynamic"
            TRAEFIK_DST_DYNAMIC="/srv/traefik/dynamic"
            if [ -d "$TRAEFIK_SRC_DYNAMIC" ]; then
              if [ -w "$TRAEFIK_DST_DYNAMIC" ]; then
                cp -f "$TRAEFIK_SRC_DYNAMIC/"*.yml "$TRAEFIK_DST_DYNAMIC/" 2>/dev/null || true
              elif command -v sudo >/dev/null 2>&1 && sudo -n true 2>/dev/null; then
                sudo mkdir -p "$TRAEFIK_DST_DYNAMIC"
                sudo cp -f "$TRAEFIK_SRC_DYNAMIC/"*.yml "$TRAEFIK_DST_DYNAMIC/" 2>/dev/null || true
              else
                echo "ERROR: Cannot sync Traefik dynamic config to $TRAEFIK_DST_DYNAMIC (no write permission and no passwordless sudo)."
                exit 1
              fi

              if [ -f "$TRAEFIK_SRC_DYNAMIC/plugai.yml" ] && [ ! -f "$TRAEFIK_DST_DYNAMIC/plugai.yml" ]; then
                echo "ERROR: Expected $TRAEFIK_DST_DYNAMIC/plugai.yml after sync but it was not found."
                exit 1
              fi
            fi

            cd "$VPS_CONFIG_ROOT/llm_api"
            docker compose up -d --build --remove-orphans
